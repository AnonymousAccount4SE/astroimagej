name: Generate All OS Distributions

on: workflow_dispatch # manually triggered

jobs:
  windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v2
      - name: Set up JDK 15
        uses: actions/setup-java@v1
        with:
          java-version: 15
        #- name: Install WiX Toolset
        #run: choco install wixtoolset
        env:
          ON_GITHUB: true
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
      - name: Make Common Files
        run: ./gradlew commonFiles
      - name: Unzip JREs
        run: ./gradlew unZipJresTask
      - name: Build AIJ
        run: ./gradlew build
      - name: Package AIJ
        run: ./gradlew packageAijForWindows_x86
      - uses: actions/upload-artifact@v2
        with:
          name: Windows Installer (.exe)
          path: build/distributions/AstroImageJ-x86_64.exe
      - uses: actions/upload-artifact@v2
        with:
          name: Windows package (.zip)
          #path: build/distributions
          path: build/distributions/AstroImageJ-x86_64-windows.zip
  linux:

    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2
      - name: Set up JDK 15
        uses: actions/setup-java@v1
        with:
          java-version: 15
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
      - name: Make Common Files
        run: ./gradlew commonFiles
      - name: Unzip JREs
        run: ./gradlew unZipJresTask
      - name: Build AIJ
        run: ./gradlew build
      - name: Package AIJ
        run: ./gradlew packageAijForLinux_x86
      - uses: actions/upload-artifact@v2
        with:
          name: Linux Compressed tar file (.tar.gz)
          path: build/distributions/AstroImageJ-x86_64-linux.tar.gz #TODO once installer generation is added, gen and upload installers
  macos:

    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v2
      - name: Set up JDK 15
        uses: actions/setup-java@v1
        with:
          java-version: 15
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
      - name: Make Common Files
        run: ./gradlew commonFiles
      - name: Make ini writable I hope
        run: chmod u=rwx build/commonFiles/AstroImageJ.l4j.ini
      - name: Unzip JREs
        run: ./gradlew unZipJresTask
      - name: Build AIJ
        run: ./gradlew build
      - name: Package AIJ
        run: ./gradlew packageAijForMac_x86 packageAijForMac_arm
      - uses: actions/upload-artifact@v2
        with:
          name: MacOS x86 App Version (.zip)
          path: build/distributions/AstroImageJ-x86_64-mac.zip
      - uses: actions/upload-artifact@v2
        with:
          name: MacOS Arm App Version (.zip)
          path: build/distributions/AstroImageJ-arm_64-mac.zip
      - uses: actions/upload-artifact@v2
        with:
          name: MacOS Arm App Version (.dmg)
          path: build/distributions/AstroImageJ-arm_64-mac.dmg
      - uses: actions/upload-artifact@v2
        with:
          name: MacOS x86 Dmg Version (.dmg)
          path: build/distributions/AstroImageJ-x86_64.dmg
